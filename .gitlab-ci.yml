image: python:3.8-slim-buster
# include: "https://gitlab.com/gitlab-cd/ssh-template/raw/master/ssh.yml"

variables:
  POSTGRES_USER: "gkadmin"
  POSTGRES_PASSWORD: "gkadmin"
  POSTGRES_DB: "gkdata"
  GKCORE_DB_URL: "postgres://gkadmin:gkadmin@postgres:5432/gkdata"

  # WARN: add razorpay:ifsc image when related tests are added
services:
  - postgres:alpine

stages:
  - build
  - deploy

# build gkcore
gkcore:
  stage: build
  script:
    - apt update && apt install -y build-essential libpq-dev
    - pip3 install -r requirements.txt
    - python3 setup.py develop
    - python3 initdb.py
    - pserve production.ini
    # run tests
    - python3 gkcore/tests/public_apis.py

# generate api docs
pages:
  stage: build
  script:
    # install required gkcore dependencies for gkcore to make pdoc to work
    - apt update && apt install -y build-essential libpq-dev
    # install the gkcore pip dependencies
    - pip install -r requirements.txt
    # install & generate api docs with pdoc
    - pip install pdoc
    - pdoc -o .pub/gkcore-api-docs/ gkcore/
    # compress the docs & move to public dir
    - tar -cf gkcore-api-docs.tar.gz .pub/gkcore-api-docs/
    - mv gkcore-api-docs.tar.gz .pub/
    # rename the dir to match gitlab ci's reserved "public" dir name
    - mv .pub public
    # gzip the public dir
    - gzip -k -9 $(find public -type f)
  artifacts:
    paths:
      - public

# run unit tests
# unit-tests:
#   stage: build
#   needs: ["setup"]
#   script:
#     - pip3 install requests
#     - python3 gkcore/tests/public_apis.py

# deploy devel branch changes to gkcore test server
update_test_server:
  stage: deploy
  script:
    - apt update && apt install -y curl
    - curl $TEST_SERVER_HOOK
  only:
    - devel
