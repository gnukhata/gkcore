image: python:3.8-slim-buster
# include: "https://gitlab.com/gitlab-cd/ssh-template/raw/master/ssh.yml"

variables:
  POSTGRES_USER: "gkadmin"
  POSTGRES_PASSWORD: "gkadmin"
  POSTGRES_DB: "gkdata"
  GKCORE_DB_URL: "postgres://gkadmin:gkadmin@postgres:5432/gkdata"

# TODO add razorpay:ifsc image when related tests are added
services:
  - postgres:alpine

stages:
  - build
  - deploy

# build gkcore
build:
  stage: build
  script:
    - apt update && apt install -y build-essential libpq-dev
    - pip3 install -r requirements.txt
    - python3 setup.py develop
    - python3 initdb.py
    - pserve production.ini

# run tests
tests:
  stage: build
  script:
    - pip3 install requests
    - python3 gkcore/tests/public_apis.py
  dependencies:
    - build

# deploy devel branch to test server
deploy:
  stage: deploy
  dependencies:
    - tests
  script:
    - apt update && apt install -y curl
    - curl $TEST_SERVER_HOOK
  only:
    - devel
